{% extends 'core/base.html' %}
{% load static %}

{% block title %}
<title>Cart</title>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4" id="cartapp" v-cloak>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="order-last md:order-first">
            <h1 class="text-2xl font-bold mb-4">Your Cart</h1>
            <div v-for="product in products" :key="product.id" class="flex items-center justify-between p-4 border rounded-lg mb-4">
                <div>
                    <h2 class="font-bold text-lg">[[ product.title ]]</h2>
                    <p class="text-gray-600">Price: $[[ product.price ]]</p>
                    <p class="text-gray-600">Total: $[[ product.total_price ]]</p>
                    <div class="flex items-center mt-2">
                        <button @click="decrementQuantity(product.id, product.quantity, product.price)" class="px-2 py-1 bg-red-500 text-white rounded-lg">-</button>
                        <span class="mx-2">[[ product.quantity ]]</span>
                        <button @click="incrementQuantity(product.id, product.quantity, product.price)" class="px-2 py-1 bg-green-500 text-white rounded-lg">+</button>
                        <button @click="removeFromCart(product.id)" class="ml-4 px-2 py-1 bg-red-500 text-white rounded-lg">Remove</button>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between p-4 border rounded-lg">
                <input type="text" v-model="coupon_code" placeholder="Coupon Code" class="p-2 border rounded-lg flex-grow">
                <button @click="applyCoupon" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg">Apply</button>
            </div>
            <p v-if="showCouponCodeError" class="text-red-500 mt-2">Invalid Coupon Code</p>
        </div>
        <div class="order-first md:order-last">
            <h1 class="text-2xl font-bold mb-4">Checkout</h1>
            <div class="p-4 border rounded-lg mb-4">
                <form @submit.prevent="buy('stripe')">
                    <div class="mb-4">
                        <label class="block mb-2">First Name</label>
                        <input type="text" v-model="first_name" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Last Name</label>
                        <input type="text" v-model="last_name" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Email</label>
                        <input type="email" v-model="email" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Address</label>
                        <input type="text" v-model="address" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Zipcode</label>
                        <input type="text" v-model="zipcode" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Place</label>
                        <input type="text" v-model="place" class="p-2 border rounded-lg w-full">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg">Buy Now</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
console.log('Products JSON:', '{{ productsstring|safe }}');

new Vue({
    el: '#cartapp',
    delimiters: ['[[', ']]'],
    data: {
        products: JSON.parse('{{ productsstring|default:"[]"|safe }}'),
        first_name: '',
        last_name: '',
        email: '',
        address: '',
        zipcode: '',
        place: '',
        coupon_code: '',
        showCouponCodeError: false
    },
    methods: {
        incrementQuantity(productId, quantity, price) {
            const product = this.products.find(p => p.id === productId);
            product.quantity++;
            product.total_price = product.quantity * product.price;
        },
        decrementQuantity(productId, quantity, price) {
            const product = this.products.find(p => p.id === productId);
            if (product.quantity > 1) {
                product.quantity--;
                product.total_price = product.quantity * product.price;
            }
        },
        removeFromCart(productId) {
            fetch('{% url "api_remove_from_cart" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 'product_id': productId })
            })
            .then(response => response.json())
            .then(data => {
                this.products = this.products.filter(p => p.id !== productId);
                // Update the cart icon or total if necessary
            });
        },
        applyCoupon() {
            // Implement the logic to apply the coupon code
            // and update the total price if the coupon is valid
        },
        buy(paymentMethod) {
            // Implement the logic to process the payment
            // and complete the order
        }
    }
});
</script>
{% endblock %}
