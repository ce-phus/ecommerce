html
Copy code
{% extends 'core/base.html' %}
{% load static %}

{% block title %}Cart | {% endblock %}

{% block content %}
<div class="container mx-auto p-4" id="cartapp" v-cloak>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="order-last md:order-first">
            <h1 class="text-2xl font-bold mb-4">Your Cart</h1>
            <div v-for="product in products" :key="product.id" class="flex items-center justify-between p-4 border rounded-lg mb-4">
                <div>
                    <h2 class="font-bold text-lg">[[ product.title ]]</h2>
                    <p class="text-gray-600">Price: Ksh [[ product.price ]]</p>
                    <p class="text-gray-600">Total: Ksh [[ product.total_price ]]</p>
                    <div class="flex items-center mt-2">
                        <button @click="decrementQuantity(product.id)" class="px-2 py-1 bg-red-500 text-white rounded-lg">-</button>
                        <span class="mx-2">[[ product.quantity ]]</span>
                        <button @click="incrementQuantity(product.id)" class="px-2 py-1 bg-green-500 text-white rounded-lg">+</button>
                        <button @click="removeFromCart(product.id)" class="ml-4 px-2 py-1 bg-red-500 text-white rounded-lg">Remove</button>
                    </div>
                </div>
                <!-- <div>
                    <img :src="product.image.url" alt="Product Image" class=""/>
                </div> -->
            </div>
            <div class="flex items-center justify-between p-4 border rounded-lg">
                <input type="text" v-model="coupon_code" placeholder="Coupon Code" class="p-2 border rounded-lg flex-grow">
                <button @click="applyCoupon" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg">Apply</button>
            </div>
            <p v-if="showCouponCodeError" class="text-red-500 mt-2">Invalid Coupon Code</p>
        </div>
        <div class="order-first md:order-last">
            <h1 class="text-2xl font-bold mb-4">Checkout</h1>
            <div class="p-4 border rounded-lg mb-4">
                <div class="mb-4">
                    <p class="text-lg">Total Items: [[ totalItems ]]</p>
                    <p class="text-lg">Total Cost: Ksh [[ totalCost ]]</p>
                </div>
                <form @submit.prevent="buy('stripe')">
                    <div class="mb-4">
                        <label class="block mb-2">First Name</label>
                        <input type="text" v-model="first_name" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Last Name</label>
                        <input type="text" v-model="last_name" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Email</label>
                        <input type="email" v-model="email" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Phone</label>
                        <input type="phone" v-model="phone" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Address</label>
                        <input type="text" v-model="address" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Zipcode</label>
                        <input type="text" v-model="zipcode" class="p-2 border rounded-lg w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2">Place</label>
                        <input type="text" v-model="place" class="p-2 border rounded-lg w-full">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg">Buy Now</button>
                </form>
                <div id="paypal-button-container" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>

<script type="application/javascript" src="https://www.paypal.com/sdk/js?client-id={{ pub_key_paypal }}"></script>
<script>
console.log('Products JSON:', '{{ productsstring|safe }}');

new Vue({
    el: '#cartapp',
    delimiters: ['[[', ']]'],
    data: { 
        errors: [],
        products: JSON.parse('{{ productsstring|default:"[]"|safe }}').map(product => ({
            ...product,
            total_price: parseFloat(product.total_price) || 0,
            price: parseFloat(product.price) || 0,
            quantity: parseInt(product.quantity) || 0
        })),
        first_name: '{{ first_name }}',
        last_name: '{{ last_name }}',
        email: '{{ email }}',
        phone: '{{ phone }}',
        address: '{{ address }}',
        zipcode: '{{ zipcode }}',
        place: '{{ place }}',
        coupon_value: 0,
        coupon_code: '',
        showCouponCodeError: false
    },
    mounted() {
        const amount = this.totalCostWithCoupon.toString();

        paypal.Buttons({
            onClick: () => {
                if (this.validateForm() > 0) {
                    return false;
                }
            },
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: amount
                        }
                    }]
                });
            },
            onApprove: (data, actions) => {
                const formdata = {
                    'first_name': this.first_name,
                    'last_name': this.last_name,
                    'email': this.email,
                    'address': this.address,
                    'zipcode': this.zipcode,
                    'place': this.place,
                    'phone': this.phone,
                    'coupon_code': this.coupon_code,
                    'gateway': 'paypal',
                    'order_id': data.orderID
                };

                return actions.order.capture().then(function(details) {
                    fetch('/api/create_checkout_session/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(formdata)
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(result) {
                        window.location.href = '/cart/success/';
                    })
                    .catch(function(error) {
                        console.log('error:', error);
                    });
                });
            }
        }).render('#paypal-button-container');
    },
    computed: {
        totalItems() {
            return this.products.reduce((total, product) => total + product.quantity, 0);
        },
        totalCost() {
            const total = this.products.reduce((total, product) => total + product.total_price, 0);
            return total.toFixed(2);
        },
        totalCostWithCoupon() {
            if (this.coupon_value > 0) {
                return this.totalCost * (1 - this.coupon_value / 100);
            } else {
                return this.totalCost;
            }
        }
    },
    methods: {
        validateForm() {
            this.errors = [];

            if (this.first_name === '') {
                this.errors.push('First name is empty');
            }

            if (this.last_name === '') {
                this.errors.push('Last name is empty');
            }

            if (this.email === '') {
                this.errors.push('Email is empty');
            }

            if (this.address === '') {
                this.errors.push('Address is empty');
            }

            if (this.zipcode === '') {
                this.errors.push('Zip code is empty');
            }

            if (this.place === '') {
                this.errors.push('Place is empty');
            }

            if (this.phone === '') {
                this.errors.push('Phone is empty');
            }

            return this.errors.length;
        },
        incrementQuantity(productId) {
            const product = this.products.find(p => p.id === productId);
            product.quantity++;
            product.total_price = product.quantity * product.price;
        },
        decrementQuantity(productId) {
            const product = this.products.find(p => p.id === productId);
            if (product.quantity > 1) {
                product.quantity--;
                product.total_price = product.quantity * product.price;
            }
        },
        removeFromCart(productId) {
            fetch('{% url "api_remove_from_cart" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 'product_id': productId })
            })
            .then(response => response.json())
            .then(data => {
                this.products = this.products.filter(p => p.id !== productId);
                // Update the cart icon or total if necessary
            });
        },
        applyCoupon() {
            if (this.coupon_code !== '') {
                fetch('/api/can_use/?coupon_code=' + this.coupon_code, {
                    method: 'GET'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.amount) {
                        this.showCouponCodeError = false;
                        this.coupon_value = parseInt(data.amount);
                    } else {
                        this.coupon_value = 0;
                        this.showCouponCodeError = true;
                    }
                });
            } else {
                this.showCouponCodeError = true;
            }
        },
        buy(paymentMethod) {
            // Implement the logic to process the payment
            // and complete the order
        }
    }
});
</script>
{% endblock %}